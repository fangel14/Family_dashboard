<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title>Family Command Center</title>
    <style>
        :root {
            --bg: #FFFFFF;
            --panel: #F9F9FB;
            --text: #1C1C1E;
            --accent: #007AFF;
            --dim-text: #8E8E93;
            --p-blue: #E3F2FD; --p-green: #E8F5E9; --p-red: #FFEBEE; --p-yellow: #FFF9C4; --p-purple: #F3E5F5;
            --t-blue: #0277BD; --t-green: #2E7D32; --t-red: #C62828; --t-yellow: #F9A825; --t-purple: #6A1B9A;
        }

        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%;
            background: var(--bg); color: var(--text);
            font-family: -apple-system, system-ui, sans-serif;
            overflow: hidden; font-size: 1.1vw;
        }

        header {
            height: 10vh; min-height: 80px;
            background: var(--panel); border-bottom: 2px solid #E5E5EA;
            display: flex; align-items: center; padding: 0 2.5vw;
            justify-content: space-between;
        }

        .nav-group { display: flex; background: #E5E5EA; border-radius: 14px; padding: 5px; gap: 5px; }
        .nav-btn {
            padding: 0.7rem 1.4rem; font-size: 1.8rem; cursor: pointer;
            border-radius: 10px; border: none; background: none; transition: all 0.2s;
        }
        .nav-btn.active { background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-1px); }

        .countdown-container { flex: 1; max-width: 20vw; margin: 0 3vw; }
        .countdown-label { 
            font-size: 0.8rem; font-weight: 800; display: flex; 
            justify-content: space-between; margin-bottom: 6px; color: #2E7D32;
        }
        .progress-outer { width: 100%; height: 6px; background: #E5E5EA; border-radius: 3px; overflow: hidden; }
        #countdown-fill { width: 75%; height: 100%; background: #34C759; transition: width 1s ease-in-out; }

        .weather-block { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .weather-img { width: 4.5rem; height: 4.5rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.05)); }
        #current-temp { font-size: 2.2rem; font-weight: 800; color: var(--text); letter-spacing: -1px; }

        main { height: 90vh; overflow: hidden; background: var(--bg); position: relative; }
        .view { display: none; padding: 2.5rem; height: 100%; box-sizing: border-box; }
        .view.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        #weather-drawer {
            position: fixed; top: -110%; left: 0; width: 100%;
            background: var(--panel); border-bottom: 5px solid var(--accent);
            box-shadow: 0 15px 50px rgba(0,0,0,0.2);
            z-index: 10001; transition: top 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            padding: 40px 15px 0; box-sizing: border-box;
            border-radius: 0 0 40px 40px; touch-action: none;
        }
        #weather-drawer.active { top: 0; }
        #forecast-container { display: flex; gap: 10px; justify-content: space-between; padding: 10px 0 30px; width: 100%; }
        .forecast-card {
            background: #F2F2F7; padding: 12px 8px; border-radius: 20px;
            text-align: center; flex: 1; min-width: 0;
            display: flex; flex-direction: column; align-items: center; gap: 4px; border: 1px solid #E5E5EA;
        }
        .fc-day { font-weight: 800; font-size: 0.85rem; color: var(--text); }
        .fc-temp { font-weight: 800; font-size: 1rem; color: var(--text); }
        .psr-label { font-size: 0.6rem; font-weight: 800; padding: 4px 6px; border-radius: 6px; background: white; color: var(--accent); width: 90%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .fc-icon { width: 3.2rem; height: 3.2rem; }
        #drawer-drag-zone { width: 100%; height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: grab; }
        .visual-handle { width: 80px; height: 8px; background: #D1D1D6; border-radius: 4px; }

        .calendar-layout { display: flex; height: 100%; position: relative; overflow: hidden; }
        .time-gutter { width: 70px; border-right: 1px solid #E5E5EA; background: #fafafa; padding-top: 60px; flex-shrink: 0; }
        .calendar-grid { flex: 1; display: grid; grid-template-columns: repeat(7, 1fr); position: relative; overflow-y: auto; overflow-x: hidden; /* Prevents Saturday from sliding off-screen */ height: 100%; }
        .day-column { border-right: 1px solid #F2F2F7; position: relative; min-height: 1800px; padding-top: 60px; background-image: linear-gradient(#F2F2F7 1px, transparent 1px); background-size: 100% 90px; }
        #view-calendar .day-column { background-image: linear-gradient(#F2F2F7 1px, transparent 1px); background-size: 100% 90px; }
        .day-header { position: absolute; top: 0; left: 0; right: 0; height: 60px; text-align: center; display: flex; flex-direction: column; justify-content: center; background: white; z-index: 10; border-bottom: 1px solid #E5E5EA; }
        .is-weekend { background-color: #f7fdff; }       
        .task-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; height: 100%; }
        .task-day { background: #f9f9fb; border-radius: 15px; padding: 10px; display: flex; flex-direction: column; gap: 8px; border: 1px solid #eee; }
        .task-day-header { font-weight: 800; font-size: 0.8rem; text-transform: uppercase; color: var(--dim-text); text-align: center; margin-bottom: 5px; }

        .event-card { border-radius: 12px; padding: 10px; font-size: 1.3rem; box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; border: 1px solid rgba(0,0,0,0.05); }
        #view-calendar .event-card { position: absolute; left: 4px; right: 4px; }
        #view-tasks .event-card { position: relative; margin-bottom: 2px; height: auto !important; }
        .event-title { font-weight: 800; color: #000; line-height: 1.2; margin-bottom: 4px; }
        .event-time { font-size: 1rem; font-weight: 700; color: rgba(0,0,0,0.5); }
        .avatar-bubble {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 10px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;       /* Added: Makes the letter clearer */
            border: 1px solid white;
            margin-left: -7px;
            line-height: 1;         /* Added: Prevents offset in some browsers */
        }
        .avatar-stack { display: flex; bottom: 5px; right: 5px; }
        .time-label { height: 90px; display: flex; align-items: flex-start; justify-content: flex-end; padding-right: 10px; color: var(--dim-text);font-size: 0.75rem; font-weight: 700; box-sizing: border-box; transform: translateY(-0.5em); }

        .chores-container { display: flex; gap: 20px; height: 100%; }
        .kid-column { flex: 1; display: flex; flex-direction: column; gap: 20px; }
        .kid-profile { text-align: center; padding: 10px; }
        .kid-avatar { width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 900; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .chore-card { background: white; border-radius: 24px; padding: 20px; border: 4px solid transparent; transition: all 0.3s; display: flex; flex-direction: column; gap: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .chore-card.complete { border-color: #FFD60A; box-shadow: 0 10px 20px rgba(255, 214, 10, 0.2); }
        .star-row { font-size: 3rem; cursor: pointer; color: #E5E5EA; display: flex; gap: 8px; justify-content: center; }
        .star-row .filled { color: #FFD60A; }
        .button-reserve { min-height: 50px; display: flex; align-items: center; justify-content: center; }
        .claim-btn { width: 100%; padding: 12px; border-radius: 14px; border: none; font-weight: 800; cursor: pointer; display: none; }
        .claim-btn.yt { background: #34C759; color: white; }
        .claim-btn.physical { background: #FF9500; color: white; }

        #notes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 25px; padding: 10px; }
        .sticky-note { aspect-ratio: 1/1; padding: 20px; border-radius: 2px; box-shadow: 3px 5px 12px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; transition: transform 0.2s; position: relative; }
        .sticky-note:hover { transform: scale(1.03) rotate(0deg) !important; box-shadow: 5px 10px 20px rgba(0,0,0,0.15); z-index: 10; }
        .note-text { font-size: 1.2rem; font-weight: 600; color: #333; font-family: 'Comic Sans MS', sans-serif; }
        .note-meta { font-size: 0.65rem; font-weight: 800; color: rgba(0,0,0,0.3); }
        .add-note-btn { padding: 15px 30px; background: var(--accent); color: white; border: none; border-radius: 15px; font-weight: 800; font-size: 1.1rem; cursor: pointer; box-shadow: 0 4px 10px rgba(0,122,255,0.2); }

        #status-box { position: fixed; bottom: 12px; right: 12px; background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); padding: 6px 10px; border-radius: 8px; border: 1px solid #D1D1D6; font-size: 0.6rem; color: var(--dim-text); text-align: right; z-index: 1000; }
        #sleep-screen { position: fixed; inset: 0; background: #000; z-index: 10000; display: none; align-items: center; justify-content: center; cursor: pointer; }
        #dim-clock { font-size: 12vw; color: #1a1a1a; font-weight: 200; letter-spacing: -5px; }
        .blink { color: #FF3B30 !important; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.5; } }
        /* Styling for Holiday Events */
.event-card.holiday {
    background-color: #f7fdff !important; /* Light Neutral Grey */
    border: 0.5px dashed #D1D1D6 !important;
    opacity: 0.9;
}
.event-card.holiday .event-title {
    color: #8E8E93 !important; /* Dimmed text */
    font-style: italic;
}

        /* Modal Overlay */
.modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 20000;
    display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(5px);
}

/* Modal Card */
.modal-card {
    background: white; width: 90%; max-width: 500px; padding: 25px;
    border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.2);
    display: flex; flex-direction: column; gap: 15px;
}

.modal-card h2 { margin: 0 0 5px 0; font-size: 1.5rem; }

/* Inputs */
.modal-input, .modal-input-lg {
    width: 100%; padding: 12px; border: 1px solid #E5E5EA; border-radius: 12px;
    font-size: 1rem; box-sizing: border-box; background: #F9F9FB;
}
.modal-input-lg { font-size: 1.2rem; font-weight: 600; }
label { display: block; font-size: 0.7rem; font-weight: 800; color: #8E8E93; margin-bottom: 5px; text-transform: uppercase; }

/* Family Tags */
.family-tags { display: flex; gap: 10px; margin: 5px 0; }
.tag-check { cursor: pointer; position: relative; }
.tag-check input { display: none; }
.tag-check span {
    padding: 8px 16px; border-radius: 20px; background: #F2F2F7;
    color: #8E8E93; font-weight: 700; font-size: 0.9rem; display: block;
    border: 2px solid transparent; transition: all 0.2s;
}
.tag-check input:checked + span {
    background: var(--tag-color); color: var(--tag-text);
    border-color: var(--tag-text); box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Layout Helpers */
.form-row { display: flex; gap: 15px; align-items: flex-end; }
.btn-group { display: flex; gap: 10px; }
.btn-group button {
    flex: 1; padding: 10px; border: none; background: #E5E5EA; border-radius: 8px;
    font-weight: 700; cursor: pointer;
}

/* Actions */
.modal-actions { display: flex; gap: 10px; margin-top: 10px; }
.btn-cancel { flex: 1; padding: 15px; border-radius: 12px; border: none; background: #F2F2F7; font-weight: 700; font-size: 1rem; color: #333; }
.btn-save { flex: 2; padding: 15px; border-radius: 12px; border: none; background: var(--accent); font-weight: 700; font-size: 1rem; color: white; }
.btn-delete { flex: 0.5; padding: 15px; border-radius: 12px; border: none; background: #FF3B30; font-weight: 700; font-size: 1rem; color: white; }

        #fab-add { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 30px; background: var(--accent); color: white; font-size: 30px; border: none; box-shadow: 0 4px 15px rgba(0,122,255,0.4); cursor: pointer; z-index: 100; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
        #fab-add:active { transform: scale(0.95); }

/* MEGA BUBBLES for Task View */
#view-tasks .event-card {
    min-height: 100px; /* Even bigger */
    margin-bottom: 15px;
    padding: 18px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    gap: 8px;
}

#view-tasks .event-title {
    font-size: 1.3rem; /* Highly readable */
    width: 85%; /* Leave room for avatars if they move */
}

#view-tasks .event-time {
    font-size: 0.9rem;
    color: var(--text); /* Make time darker and more prominent */
    font-weight: 800;
    background: rgba(255,255,255,0.5);
    padding: 2px 6px;
    border-radius: 4px;
    width: fit-content;
}

#view-tasks .avatar-stack {
    bottom: 12px;
    right: 12px;
    position: sticky;
}

#view-tasks .avatar-bubble {
    width: 30px;
    height: 30px;
    font-size: 16px;
    border: 2px solid white;
}

/* Ensure Task View Indicators are Visible */
#view-tasks .task-day.is-weekend { 
    background-color: #f7fdff !important; 
}

#view-tasks .task-day.has-holiday { 
    border: 2px dashed #D1D1D6 !important; 
    background-color: #fafafa !important;
}

/* Optional: Make the text color change for Holidays to be extra clear */
#view-tasks .task-day.has-holiday .task-day-header {
    color: var(--accent) !important;
}

/* Today Highlight for Tasks */
#view-tasks .task-day.is-today {
    border: 3px solid var(--accent) !important;
    background-color: #f0f7ff !important;
}

/* Align avatars to the right inside calendar cards */
.event-card .avatar-stack {
    position: absolute;
    bottom: 8px;      /* Anchors to bottom */
    right: 8px;       /* Anchors to right */
    left: auto;       /* Removes any left-side bias */
    display: flex;
    flex-direction: row-reverse; /* Bubbles stack from right-to-left */
    justify-content: flex-start;
    gap: 0;           /* Maintain overlap if desired */
}

/* Ensure the title leaves enough room so it doesn't overlap avatars */
.event-card .event-title {
    padding-right: 40px; /* Space for the avatars on the right */
    width: 100%;
    box-sizing: border-box;
}

.event-card .avatar-stack {
    position: absolute;
    bottom: 8px;
    right: 8px; /* Anchor to the right */
    left: auto;
    display: flex;
    flex-direction: row-reverse; /* Stack from right to left */
}

.event-card .event-title {
    padding-right: 35px; /* Leave room for the avatars */
}

/* Star System Styling */
.star-rating span {
    font-size: 2.5rem;
    cursor: pointer;
    color: #f0f0f0; /* Empty star color */
    transition: color 0.2s, transform 0.1s;
    display: inline-block;
    padding: 0 5px;
}

.star-rating span.filled {
    color: #FFD700; /* Gold earned star */
}

/* Ensure the chore card looks like your reference */
.chore-card {
    background: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

    </style>
</head>
<body>

<div id="sleep-screen" onclick="wakeUp()"><div id="dim-clock">12:34</div></div>

<header>
    <div style="display: flex; gap: 15px; align-items: center;">
        <div class="nav-group">
            <button class="nav-btn active" onclick="switchView('calendar', this)">üìÖ</button>
            <button class="nav-btn" onclick="switchView('tasks', this)">üìã</button>
            <button class="nav-btn" onclick="switchView('chores', this)">‚≠êÔ∏è</button>
            <button class="nav-btn" id="sticky-btn" onclick="switchView('sticky', this)">üìù</button>
        </div>
        
        <div class="nav-group">
            <button class="nav-btn" onclick="changeWeek(-7)">‚óÄ</button>
            <button class="nav-btn" onclick="goToToday()" style="font-size: 0.8rem; font-weight: 800;">TODAY</button>
            <button class="nav-btn" onclick="changeWeek(7)">‚ñ∂</button>
        </div>
    </div>
    <div class="countdown-container">
        <div class="countdown-label"><span>‚úàÔ∏è Japan Trip</span><span id="days-text">5 Days Until</span></div>
        <div class="progress-outer"><div id="countdown-fill"></div></div>
    </div>
    <div class="weather-block" onclick="toggleWeatherDrawer()">
        <img id="weather-icon" class="weather-img" src="https://basmilius.github.io/weather-icons/production/fill/all/clear-day.svg">
        <div class="weather-info">
            <div style="display: flex; align-items: baseline; gap: 8px;">
                <span id="current-temp">--¬∞C</span>
                <span id="current-humidity">--% RH</span>
            </div>
            <div id="weather-desc">Syncing...</div>
        </div>
    </div>
</header>

<div id="weather-drawer">
    <div class="drawer-content">
        <div class="drawer-header" style="text-align:center;">
            <h3>5-Day Forecast</h3>
            <div style="font-size: 0.8rem; color: var(--dim-text);">Sham Shui Po Station</div>
        </div>
        <div id="forecast-container"></div>
        
        <div id="drawer-drag-zone">
            <div class="visual-handle"></div>
            <span style="font-size: 0.7rem; font-weight: 800; color: #AEAEB2; margin-top: 10px;">DRAG UP TO CLOSE</span>
        </div>
    </div>
</div>

<main>
    <div id="view-calendar" class="view active">
        <div class="calendar-layout">
            <div class="time-gutter" id="calendar-time-gutter"></div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>
    </div>

    <div id="view-tasks" class="view"><div class="task-grid" id="task-grid"></div></div>

    <div id="view-chores" class="view">
        <div class="chores-container">
            <div class="kid-column">
                <div class="kid-profile">
                    <div class="kid-avatar" style="background:var(--p-blue); color:var(--t-blue)">L</div>
                    <h2>Laelynn</h2>
                </div>
                <div class="chore-stack" id="chores-laelynn"></div> 
            </div>

            <div class="kid-column">
                <div class="kid-profile">
                    <div class="kid-avatar" style="background:var(--p-yellow); color:var(--t-yellow)">M</div>
                    <h2>Makayla</h2>
                </div>
                <div class="chore-stack" id="chores-makayla"></div>
            </div>
        </div>
    </div>

    <div id="view-sticky" class="view">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h1 style="margin:0; font-weight:800; color:var(--accent);">Family Notes</h1>
            <button class="add-note-btn" onclick="promptNewNote()">+ Add Note</button>
        </div>
        <div id="notes-grid"></div>
    </div>
</main>

<div id="status-box"><div id="bat-lvl">Battery: --%</div><div id="sync-ts">Sync: --:--</div></div>

<div id="event-modal-overlay" class="modal-overlay" style="display: none;">
    <div class="modal-card">
        <h2>Family Event</h2>
        
        <!-- Title Input -->
        <input type="text" id="evt-title" placeholder="Event Title (e.g. Piano Practice)" class="modal-input-lg">
        
        <!-- Family Member Checkboxes -->
        <div class="family-tags">
            <label class="tag-check" style="--tag-color: #B5EAD7; --tag-text: #0277BD">
                <input type="checkbox" value="E"> <span>Dad</span>
            </label>
            <label class="tag-check" style="--tag-color: #C7CEEA; --tag-text: #C62828">
                <input type="checkbox" value="H"> <span>Mom</span>
            </label>
            <label class="tag-check" style="--tag-color: #FFB7B2; --tag-text: #6A1B9A">
                <input type="checkbox" value="L"> <span>Laelynn</span>
            </label>
            <label class="tag-check" style="--tag-color: #FFF9C4; --tag-text: #F9A825">
                <input type="checkbox" value="M"> <span>Makayla</span>
            </label>
        </div>

        <!-- Date & Time Row -->
        <div class="form-row">
            <div class="form-group" style="flex: 2;">
                <label>DATE</label>
                <input type="date" id="evt-date" class="modal-input">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>START</label>
                <input type="time" id="evt-start" class="modal-input">
            </div>
        </div>

        <!-- End Time & Quick Add Row -->
        <div class="form-row">
            <div class="form-group" style="flex: 1;">
                <label>END</label>
                <input type="time" id="evt-end" class="modal-input">
            </div>
            <div class="quick-add-group">
                <label>QUICK ADD</label>
                <div class="btn-group">
                    <button onclick="adjustTime(30)">+30m</button>
                    <button onclick="adjustTime(60)">+1h</button>
                </div>
            </div>
        </div>

        <!-- Repeat Dropdown -->
        <div class="form-group">
            <label>REPEAT WEEKLY FOR...</label>
            <select id="evt-repeat" class="modal-input">
                <option value="none">No Repeat</option>
                <option value="4">1 Month (4 weeks)</option>
                <option value="12">3 Months (12 weeks)</option>
                <option value="52">1 Year (52 weeks)</option>
            </select>
        </div>

        <!-- Action Buttons -->
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeModal()">Cancel</button>
            <button class="btn-save" onclick="saveEvent()">Save Event</button>
            <button id="btn-delete" class="btn-delete" style="display:none" onclick="deleteEvent()">Delete</button>
        </div>
    </div>
</div>


<button id="fab-add" onclick="promptNewEvent()">+</button>


<script src="https://www.youtube.com/iframe_api"></script>
<script>
    let idleLogoutTimer; 
    let currentViewDate = getStartOfWeek(new Date());

    const CONFIG = { };
    
    const SHORT_TAGS = {
    "#L": "Laelynn",
    "#M": "Makayla",
    "#E": "Dad",
    "#H": "Mom"
    };

    const USER_MAP = {
        "Laelynn": { color: "#FFB7B2", text: "#6A1B9A" },
        "Makayla": { color: "#FFF9C4", text: "#F9A825" },
        "Dad": { color: "#B5EAD7", text: "#0277BD" },
        "Mom": { color: "#C7CEEA", text: "#C62828" }
    };

    const NOTE_COLORS = ["var(--p-yellow)", "var(--p-blue)", "var(--p-green)", "var(--p-red)", "var(--p-purple)"];

    let currentDate = new Date();
    let familyEvents = []; // START EMPTY: All data will now flow from Google

    let familyNotes = JSON.parse(localStorage.getItem('family_notes')) || [
        { id: 1, text: "Don't forget the milk! ü•õ", color: "var(--p-yellow)", ts: Date.now() }
    ];


    function switchView(viewId, btn) {
        // 1. Update Buttons
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // 2. Update Views
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-' + viewId).classList.add('active');

        // 3. Trigger Render for specific views
        if (viewId === 'calendar') renderCalendar();
        if (viewId === 'tasks') renderTasks();
        if (viewId === 'sticky') renderNotes();
    }

    // --- HELPER FUNCTIONS ---
    function getStartOfWeek(d) { const date = new Date(d); const day = date.getDay(); const diff = date.getDate() - day; return new Date(date.setDate(diff)); }
    function isToday(d) { const t = new Date(); return d.getDate() === t.getDate() && d.getMonth() === t.getMonth(); }
    function isSameDay(d1, d2) { return d1.getDate() === d2.getDate() && d1.getMonth() === d2.getMonth(); }
    function formatTime(d) { return d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }); }

    // --- WEATHER LOGIC ---
    const ICON_MAP = { "50": "clear-day", "51": "partly-cloudy-day", "52": "partly-cloudy-day", "53": "cloudy", "60": "rain", "64": "thunderstorms-rain" };
    async function refreshWeather() {
        try {
            const res = await fetch('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=rhrread&lang=en');
            const data = await res.json();
            const ssp = data.temperature.data.find(s => s.place === "Sham Shui Po");
            if(ssp) document.getElementById('current-temp').innerText = ssp.value + "¬∞C";
            document.getElementById('current-humidity').innerText = data.humidity.data[0].value + "% RH";
            const iconCode = data.icon[0];
            document.getElementById('weather-icon').src = `https://basmilius.github.io/weather-icons/production/fill/all/${ICON_MAP[iconCode] || 'clear-day'}.svg`;
            const fRes = await fetch('https://data.weather.gov.hk/weatherAPI/opendata/weather.php?dataType=fnd&lang=en');
            const fData = await fRes.json();
            renderForecast(fData.weatherForecast.slice(0, 5));
            document.getElementById('weather-desc').innerText = "Fine";
        } catch (e) { document.getElementById('weather-desc').innerText = "Sync Offline"; }
    }

    function renderForecast(forecasts) {
        const container = document.getElementById('forecast-container'); container.innerHTML = '';
        forecasts.forEach(f => {
            const raw = f.forecastDate; const formattedDate = `${raw.substring(0,4)}-${raw.substring(4,6)}-${raw.substring(6,8)}`;
            const dateObj = new Date(formattedDate);
            container.innerHTML += `<div class="forecast-card"><div class="fc-day">${dateObj.toLocaleDateString('en-US', {weekday: 'short'})}</div><img class="fc-icon" src="https://basmilius.github.io/weather-icons/production/fill/all/${ICON_MAP[f.ForecastIcon] || 'clear-day'}.svg"><div class="fc-temp">${f.forecastMintemp.value}¬∞-${f.forecastMaxtemp.value}¬∞</div><div class="psr-label">Rain: ${f.PSR || 'Low'}</div></div>`;
        });
    }

    let startY = 0;
    const drawer = document.getElementById('weather-drawer');
    const dragZone = document.getElementById('drawer-drag-zone');

    dragZone.addEventListener('touchstart', e => { startY = e.touches[0].clientY; drawer.style.transition = 'none'; });
    dragZone.addEventListener('touchmove', e => { const currentY = e.touches[0].clientY; const deltaY = currentY - startY; if (deltaY < 0) { drawer.style.top = deltaY + 'px'; } });
    dragZone.addEventListener('touchend', e => { const currentY = e.changedTouches[0].clientY; const deltaY = currentY - startY; drawer.style.transition = 'top 0.5s cubic-bezier(0.16, 1, 0.3, 1)'; if (deltaY < -80) { drawer.classList.remove('active'); drawer.style.top = '-110%'; } else { drawer.style.top = '0px'; } });

    // --- VIEW RENDERS ---
    
    function changeWeek(days) {
        currentViewDate.setDate(currentViewDate.getDate() + days);
        renderCalendar();
        renderTasks();
    }

    function goToToday() {
        currentViewDate = getStartOfWeek(new Date());
        renderCalendar();
        renderTasks();
    }

    function renderCalendar() {
        const grid = document.getElementById('calendar-grid');
        const gutter = document.getElementById('calendar-time-gutter');
        if(!grid || !gutter) return;

        grid.innerHTML = ''; 
        gutter.innerHTML = '';

        // FORCE extraction of the hour number
        let sHour = 6; // Default
        if (CONFIG.starthour) {
            // If it's a string like "10:00", get the first part. If it's a number, use it.
            sHour = parseInt(CONFIG.starthour.toString().split(':')[0]) || 6;
        }
        
        // Use currentViewDate instead of a hardcoded date
        for (let h = sHour; h <= 22; h++) {
            const lbl = document.createElement('div');
            lbl.className = 'time-label';
            lbl.innerText = h > 12 ? (h - 12) + ' PM' : (h === 12 ? '12 PM' : h + ' AM');
            gutter.appendChild(lbl);
        }

        for (let i = 0; i < 7; i++) {
            let displayDay = new Date(currentViewDate);
            displayDay.setDate(currentViewDate.getDate() + i);
            
            const col = document.createElement('div');
            const isWeekend = (displayDay.getDay() === 0 || displayDay.getDay() === 6);
            
            // FIXED: Using displayDay instead of undefined 'd'
            const isTodayDay = isToday(displayDay);
            col.className = `day-column ${isWeekend ? 'is-weekend' : ''} ${isTodayDay ? 'is-today' : ''}`;
            
            // Visual polish for the header
            col.innerHTML = `
                <div class="day-header" style="${isTodayDay ? 'border-bottom: 3px solid var(--accent);' : ''}">
                    <div class="day-name" style="${isTodayDay ? 'color: var(--accent);' : ''}">${displayDay.toLocaleDateString('en-US', {weekday: 'short'})}</div>
                    <div class="day-num" style="${isTodayDay ? 'background: var(--accent); color: white; border-radius: 50%; width: 24px; margin: 0 auto;' : ''}">${displayDay.getDate()}</div>
                </div>
            `;

            familyEvents.filter(e => isSameDay(new Date(e.start), displayDay)).forEach(evt => {
                col.appendChild(createEventElement(evt, 'calendar'));
            });
            grid.appendChild(col);
        }
    }

    function renderTasks() {
        const grid = document.getElementById('task-grid');
        if (!grid) return;
        grid.innerHTML = '';

        const start = new Date(currentViewDate);

        for (let i = 0; i < 7; i++) {
            let d = new Date(start);
            d.setDate(start.getDate() + i);

            const col = document.createElement('div');
            
            // 1. Correct logic for indicators
            const isWeekend = (d.getDay() === 0 || d.getDay() === 6);
            const isTodayDay = isToday(d);
            const dayEvents = familyEvents.filter(e => isSameDay(new Date(e.start), d));
            const hasHoliday = dayEvents.some(e => e.type === 'holiday');
            const holidayName = hasHoliday ? dayEvents.find(e => e.type === 'holiday').title : "";

            // 2. APPLY CLASSES (Moved all logic into one clean string)
            col.className = `task-day ${isWeekend ? 'is-weekend' : ''} ${isTodayDay ? 'is-today' : ''} ${hasHoliday ? 'has-holiday' : ''}`;

            // 3. SET CONTENT (Including Today & Holiday highlights)
            col.innerHTML = `
                <div class="task-day-header">
                    <div style="${isTodayDay ? 'color: var(--accent); font-weight: 900;' : ''}">
                        ${d.toLocaleDateString('en-US', {weekday: 'short'})} ${d.getDate()}
                    </div>
                    ${hasHoliday ? `<div style="font-size: 0.6rem; color: var(--accent); margin-top: 2px;">üéâ ${holidayName}</div>` : ''}
                </div>
            `;

            // 4. Add Today Border if applicable
            if (isTodayDay) {
                col.style.border = "2px solid var(--accent)";
                col.style.backgroundColor = "#F0F7FF";
            }

            // 5. Render individual events
            dayEvents.forEach(evt => {
                col.appendChild(createEventElement(evt, 'task'));
            });

            grid.appendChild(col);
        }
    }

    function createEventElement(evt, viewType) {
        const el = document.createElement('div');
        el.className = 'event-card';

        if (evt.type === 'holiday') el.classList.add('holiday');

        const start = new Date(evt.start);
        const end = new Date(evt.end);
        const tags = evt.title.match(/#\w+/g) || [];
        const users = tags.map(t => SHORT_TAGS[t] || t.replace('#', ''));
        const avatars = users.map(u => `<div class="avatar-bubble" style="background:${USER_MAP[u]?.text || '#666'}">${u[0]}</div>`).join('');

        // Apply background colors
        if (users.length > 1) {
            const stops = users.map((u, i) => `${USER_MAP[u]?.color || '#eee'} ${(100/users.length)*i}%, ${USER_MAP[u]?.color || '#eee'} ${(100/users.length)*(i+1)}%`).join(', ');
            el.style.background = `linear-gradient(135deg, ${stops})`;
        } else {
            el.style.backgroundColor = USER_MAP[users[0]]?.color || '#eee';
        }

        if (viewType === 'calendar') {
            let displayHour = start.getHours();
            let displayMin = start.getMinutes();
            
            // 1. Force sHour to a clean number from CONFIG
            const sHour = parseInt(CONFIG.starthour?.toString().split(':')[0]) || 6;

            // 2. SNAP LOGIC: If starts before grid, visually show at top
            if (displayHour < sHour) {
                displayHour = sHour;
                displayMin = 0;
            }

            // 3. Position Calculation (Fixed duplicate 'top' declaration)
            const topPos = (displayHour - sHour) * CONFIG.hourHeight + (displayMin / 60) * CONFIG.hourHeight;
            el.style.top = `calc(60px + ${topPos}px)`;
            
            let h = ((end - start) / 3600000) * CONFIG.hourHeight;
            el.style.height = Math.max(h, 45) + 'px'; 

            // 4. Visual Layout: Avatars anchored to the RIGHT
            el.innerHTML = `
                <div class="event-title" style="padding-right: 35px;">${evt.title.replace(/#\w+/g, '')}</div>
                <div class="event-time">${formatTime(start)}</div>
                <div class="avatar-stack" style="right: 8px; left: auto; flex-direction: row-reverse;">${avatars}</div>
            `;
        } else {
            // Task View Mega Bubble
            el.innerHTML = `
                <div class="event-time" style="font-weight:800; color:black; margin-bottom:5px;">${formatTime(start)}</div>
                <div class="event-title" style="font-size:1.3rem;">${evt.title.replace(/#\w+/g, '')}</div>
                <div class="avatar-stack" style="top:10px; bottom:auto; right:10px;">${avatars}</div>
            `;
        }

        el.addEventListener('click', (e) => { e.stopPropagation(); editEvent(evt.id); });
        return el;
    }

// --- EVENT MANAGEMENT (Restored) ---
// --- NEW EVENT MODAL LOGIC ---
let currentEditingId = null;

function promptNewEvent() {
    currentEditingId = null; // New mode
    document.getElementById('evt-title').value = "";
    document.querySelectorAll('.tag-check input').forEach(i => i.checked = false);
    
    // Default to today 9AM
    const now = new Date();
    document.getElementById('evt-date').value = now.toISOString().split('T')[0];
    document.getElementById('evt-start').value = "09:00";
    document.getElementById('evt-end').value = "10:00";
    document.getElementById('evt-repeat').value = "none";
    
    document.getElementById('btn-delete').style.display = 'none';
    document.getElementById('event-modal-overlay').style.display = 'flex';
}

function editEvent(id) {
    const evt = familyEvents.find(e => e.id === id);
    if (!evt) return;
    
    currentEditingId = id;
    // Clean the title for the input box
    document.getElementById('evt-title').value = evt.title.replace(/#\w+/g, '').trim();
    
    // FIXED: Check checkboxes by looking for the #Tag in the event title
    document.querySelectorAll('.tag-check input').forEach(input => {
        // This looks for "#L", "#M", etc., inside the title string
        const tagToLookFor = "#" + input.value; 
        input.checked = evt.title.includes(tagToLookFor);
    });

    const start = new Date(evt.start);
    const end = new Date(evt.end);
    
    document.getElementById('evt-date').value = start.toISOString().split('T')[0];
    document.getElementById('evt-start').value = formatInputTime(start);
    document.getElementById('evt-end').value = formatInputTime(end);
    document.getElementById('evt-repeat').value = "none";
    
    document.getElementById('btn-delete').style.display = 'block';
    document.getElementById('event-modal-overlay').style.display = 'flex';
}

function saveEvent() {
    const titleBase = document.getElementById('evt-title').value;
    if (!titleBase) return alert("Please enter a title");

    // Reconstruct tags
    let tags = "";
    document.querySelectorAll('.tag-check input:checked').forEach(i => {
        tags += " #" + i.value;
    });
    const finalTitle = titleBase + tags;

    // Construct Dates
    const dateStr = document.getElementById('evt-date').value;
    const startStr = document.getElementById('evt-start').value;
    const endStr = document.getElementById('evt-end').value;
    
    const startObj = new Date(`${dateStr}T${startStr}`);
    const endObj = new Date(`${dateStr}T${endStr}`);

    if (currentEditingId) {
        // UPDATE EXISTING
        const evt = familyEvents.find(e => e.id === currentEditingId);
        evt.title = finalTitle;
        evt.start = startObj.toISOString();
        evt.end = endObj.toISOString();
    } else {
        // CREATE NEW
        const repeatCount = document.getElementById('evt-repeat').value === "none" ? 1 : parseInt(document.getElementById('evt-repeat').value);
        
        for(let i=0; i<repeatCount; i++) {
            let nextStart = new Date(startObj);
            nextStart.setDate(startObj.getDate() + (i * 7));
            let nextEnd = new Date(endObj);
            nextEnd.setDate(endObj.getDate() + (i * 7));
            
            familyEvents.push({
                id: Date.now() + i,
                title: finalTitle,
                start: nextStart.toISOString(),
                end: nextEnd.toISOString()
            });
        }
    }

    closeModal();
    renderCalendar();
    renderTasks();
}

function deleteEvent() {
    if(confirm("Delete this event?")) {
        familyEvents = familyEvents.filter(e => e.id !== currentEditingId);
        closeModal();
        renderCalendar();
        renderTasks();
    }
}

function closeModal() {
    document.getElementById('event-modal-overlay').style.display = 'none';
}

function adjustTime(minutes) {
    const startEl = document.getElementById('evt-start');
    const endEl = document.getElementById('evt-end');
    if(!startEl.value) return;
    
    // Create date objects just to manipulate time easily
    const base = new Date(`2000-01-01T${startEl.value}`);
    const newEnd = new Date(base.getTime() + minutes * 60000);
    endEl.value = formatInputTime(newEnd);
}

function formatInputTime(date) {
    return date.toTimeString().substring(0,5);
}


    function updateSystem() { const now = new Date(); const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0'); document.getElementById('sleep-screen').style.display = (timeStr >= CONFIG.sleepStart || timeStr < CONFIG.sleepEnd) ? 'flex' : 'none'; document.getElementById('dim-clock').innerText = timeStr; if(navigator.getBattery) navigator.getBattery().then(b => { document.getElementById('bat-lvl').innerText = `Battery: ${Math.round(b.level*100)}%`; }); document.getElementById('sync-ts').innerText = `Sync: ${timeStr}`; }
    function toggleWeatherDrawer() { const d = document.getElementById('weather-drawer'); d.classList.toggle('active'); d.style.top = d.classList.contains('active') ? '0' : '-110%'; }

// --- SYSTEM HELPERS ---
function updateClock() {
    const now = new Date();
    // 1. Update the time text only
    const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
    const clockEl = document.getElementById('dim-clock');
    if (clockEl) clockEl.innerText = timeStr;

    // 2. Update battery if available
    if (navigator.getBattery) {
        navigator.getBattery().then(battery => {
            const batEl = document.getElementById('bat-lvl');
            if (batEl) batEl.innerText = `Battery: ${Math.round(battery.level * 100)}%`;
        });
    }
}

function resetIdleTimer() {
    if (typeof idleLogoutTimer !== 'undefined') clearTimeout(idleLogoutTimer);
    
    // Wake up immediately on touch
    const sleepDiv = document.getElementById('sleep-screen');
    if (sleepDiv && sleepDiv.style.display === 'flex') {
        sleepDiv.style.display = 'none';
        console.log("Activity detected: Waking up.");
    }

    // Set a fresh 5-minute countdown (300,000ms)
    idleLogoutTimer = setTimeout(() => {
        const now = new Date();
        const hr = now.getHours().toString().padStart(2, '0');
        const min = now.getMinutes().toString().padStart(2, '0');
        const currentTime = `${hr}:${min}`;
        
        // ONLY sleep if within the window set in your Google Sheet
        const isSleepTime = (currentTime >= CONFIG.sleepStart || currentTime < CONFIG.sleepEnd);
        
        if (isSleepTime && sleepDiv) {
            console.log("5 minutes inactive during sleep hours. Dimming.");
            sleepDiv.style.display = 'flex';
        }
    }, 300000); 
}

function wakeUp() {
    const sleepScreen = document.getElementById('sleep-screen');
    if (sleepScreen) {
        sleepScreen.style.display = 'none';
        console.log("iPad Awake");
    }
}

    async function init() {
        // 1. Setup Core System
        window.addEventListener('mousedown', resetIdleTimer);
        window.addEventListener('touchstart', resetIdleTimer);
        window.addEventListener('mousemove', resetIdleTimer); // Added for mouse/stylus users
        updateClock(); 
        resetIdleTimer();
        
        // 2. Initial Cloud Sync (This fills familyEvents and CONFIG)
        await syncCloudData(); 

        // 3. Weather Fetch
        await refreshWeather(); 

        // 4. Set Refresh Intervals
        setInterval(updateClock, 30000);
        setInterval(syncCloudData, 300000); // Re-sync every 5 mins
        setInterval(refreshWeather, 600000);
    }
    window.onload = init;

function renderNotes() {
    const grid = document.getElementById('notes-grid');
    if (!grid) return;
    grid.innerHTML = '';
    familyNotes.forEach(note => {
        const el = document.createElement('div');
        el.className = 'sticky-note';
        el.style.backgroundColor = note.color;
        el.style.transform = `rotate(${(Math.random() * 4 - 2)}deg)`;
        el.innerHTML = `
            <div class="note-text">${note.text}</div>
            <div class="note-meta">${new Date(note.ts).toLocaleDateString()}</div>
        `;
        el.ondblclick = () => {
            familyNotes = familyNotes.filter(n => n.id !== note.id);
            localStorage.setItem('family_notes', JSON.stringify(familyNotes));
            renderNotes();
        };
        grid.appendChild(el);
    });
}

//////
const API_URL = "https://script.google.com/macros/s/AKfycbx6_9L8yNfkIQHXxHWa7pXlphdaFggFlACl8GC61WYsvJDufjqNPh_q_9F2nzPfMyA/exec";

async function syncCloudData() {
    console.log("Starting Sync...");
    try {
        const response = await fetch(API_URL, { method: 'GET', mode: 'cors', redirect: 'follow' });
        const data = await response.json();

        // 1. Update CONFIG from Google Sheets
        if (data.settings) {
            Object.assign(CONFIG, data.settings);
            // Fix: Ensure tripDate is a valid date string for the countdown
            if (CONFIG.tripDate && CONFIG.tripDate.includes('T')) {
                CONFIG.tripDate = CONFIG.tripDate.split('T')[0];
            }       
            console.log("Config Synced. Sleep Start:", CONFIG.sleepStart);
                    
            // Calculate Countdown dynamically
            if (data.settings.tripDate) {
                const tripDate = new Date(data.settings.tripDate);
                const today = new Date();
                const diff = Math.ceil((tripDate - today) / (1000 * 60 * 60 * 24));
                
                document.querySelector('.countdown-label span:first-child').innerText = data.settings.tripTitle || "Trip";
                document.getElementById('days-text').innerText = `${diff} Days Until`;
                
                // Set progress bar (assuming a 30-day "hype" window)
                const progress = Math.max(0, Math.min(100, (1 - (diff / 30)) * 100));
                document.getElementById('countdown-fill').style.width = `${progress}%`;
            }
        }

        // 2. Load Events (This fills the calendar)
        familyEvents = data.events || [];
        console.log("Sync Successful. Events found:", familyEvents.length);

        // 3. REMOVED: The jump logic. We stay on the current week.
        
        // 4. Refresh all UI components
        renderCalendar();
        renderTasks();
        renderGoalStars(data.goals);
        updateCountdown();
        renderNotes();

        // Update footer timestamp
        const syncTs = document.getElementById('sync-ts');
        if (syncTs) syncTs.innerText = `Sync: ${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;

        return data; 
    } catch (error) { console.error("Sync Failed:", error); }
}

// This function sends the data to Google Sheets when you tap a star
async function updateStarsInCloud(kid, rewardName, count) {
    try {
        await fetch(API_URL, {
            method: 'POST',
            mode: 'no-cors', // Essential for Google Apps Script
            body: JSON.stringify({
                action: 'updateStars',
                kid: kid,
                reward: rewardName,
                count: count
            })
        });
        console.log(`Cloud Updated: ${kid} -> ${count} stars for ${rewardName}`);
    } catch (e) { console.error("Star sync failed:", e); }
}

// FIXED: Passes data directly to avoid searching the DOM
async function addStar(starSpan, kidName, goalName, newCount) {
    // 1. Instant Visual Feedback
    const starContainer = starSpan.parentElement;
    const allStars = starContainer.querySelectorAll('span');
    
    allStars.forEach((s, i) => {
        if (i < newCount) s.classList.add('filled');
        else s.classList.remove('filled');
    });

    // 2. Trigger the sync you confirmed is already working
    await updateStarsInCloud(kidName, goalName, newCount);
}

// Ensure renderGoalStars matches the new toggle function
function renderGoalStars(goalsData) {
    const containers = {
        'Laelynn': document.getElementById('chores-laelynn'),
        'Makayla': document.getElementById('chores-makayla')
    };

    // Clear old data but keep the containers
    Object.values(containers).forEach(c => { if(c) c.innerHTML = ''; });

    if (!goalsData) return;

    goalsData.forEach(goal => {
        const parent = containers[goal.Owner];
        if (!parent) return;

        const card = document.createElement('div');
        card.className = 'chore-card';
        
        const target = parseInt(goal.TargetStars) || 0;
        const current = parseInt(goal.CurrentStars) || 0;
        
        // Build the stars using the hardcoded visual logic
        let starsHtml = '';
        for(let i = 1; i <= target; i++) {
            const isFilled = i <= current ? 'filled' : '';
            starsHtml += `<span class="${isFilled}" onclick="addStar(this, '${goal.Owner}', '${goal.GoalName}', ${i})">‚òÜ</span>`;
        }
        
        // Match the text labels from your visual reference
        const rewardLabel = goal.IsYouTube == 1 
            ? `üì∫ ${goal.YTMins}m YouTube` 
            : `üéÅ ${goal.PhysicalPrize || 'Surprise!'}`;

        card.innerHTML = `
            <div class="chore-header" style="margin-bottom:10px;">
                <span style="font-size:1.1rem; font-weight:600;">${goal.GoalName}</span>
                <span style="color:#888; margin-left:10px;">${rewardLabel}</span>
            </div>
            <div class="star-rating">${starsHtml}</div>
        `;
        parent.appendChild(card);
    });
}

function updateCountdown() {
    if (!CONFIG.tripDate) return;
    const target = new Date(CONFIG.tripDate);
    const now = new Date();
    const diff = Math.ceil((target - now) / (1000 * 60 * 60 * 24));
    
    const countdownEl = document.querySelector('.Japan-Trip-Countdown'); // Adjust selector as needed
    if (countdownEl) {
        countdownEl.innerText = diff > 0 ? `${diff} Days Until` : "Time to go! ‚úàÔ∏è";
    }
}

</script>


</body>
</html>